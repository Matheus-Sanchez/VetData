name: Coleta Automatica

on:
  schedule:
    - cron: "0 20 * * *"   # 17h BRT = 20h UTC
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write
  pull-requests: write   # necess√°rio para criar PR

jobs:
  run-code:
    runs-on: ubuntu-latest

    steps:
      - name: Baixar c√≥digo da branch main
        uses: actions/checkout@v3
        with:
          ref: main

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Instalar depend√™ncias
        working-directory: Scraper
        run: |
          pip install -r requirements.txt

      - name: Executar main.py
        working-directory: Scraper
        run: |
          python main.py

      - name: Limpar os dados
        working-directory: Tratamento/src
        run: |
          python validador_dados.py

      - name: Criar PR com as altera√ß√µes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Verificar se h√° altera√ß√µes
          if [[ -z $(git status -s) ]]; then
            echo "Sem altera√ß√µes para commitar"
            exit 0
          fi
          
          # Criar branch tempor√°ria
          BRANCH_NAME="auto-coleta-$(date +'%Y%m%d-%H%M%S')"
          git checkout -b $BRANCH_NAME
          
          # Commitar altera√ß√µes
          git add .
          git commit -m "Coleta autom√°tica em $(date +'%d-%m-%Y %H:%M')"
          git push origin $BRANCH_NAME
          
          # Criar Pull Request
          gh pr create \
            --title "ü§ñ Coleta autom√°tica - $(date +'%d/%m/%Y %H:%M')" \
            --body "Dados coletados e processados automaticamente pelo workflow scheduled." \
            --base main \
            --head $BRANCH_NAME

      - name: Auto-merge do PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Aguardar um pouco para o PR ser criado
          sleep 5
          
          # Pegar o n√∫mero do √∫ltimo PR criado
          PR_NUMBER=$(gh pr list --head auto-coleta-* --json number --jq '.[0].number')
          
          if [[ -n "$PR_NUMBER" ]]; then
            # Aprovar o PR (necess√°rio se houver regra de aprova√ß√£o)
            gh pr review $PR_NUMBER --approve
            
            # Fazer merge
            gh pr merge $PR_NUMBER --squash --auto --delete-branch
            
            echo "‚úÖ PR #$PR_NUMBER criado e merged automaticamente"
          else
            echo "Nenhum PR para fazer merge"
          fi
